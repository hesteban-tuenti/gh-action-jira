name: Triggered Workflow
on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project name'
        required: true
      basename:
        description: 'Directory basename to search for features'
        required: true

jobs:
  get_matrix_features:
    runs-on: ubuntu-latest
    outputs:
        matrix: ${{ steps.set-matrix-features.outputs.matrix }}
    steps:
      - run: echo "My input is ${{ github.event.inputs.basename }}"
      
      - name: Checkout repo
        uses: actions/checkout@v4 

      - name: Retrieve all features and set matrix
        id: set-matrix-features
        shell: bash
        run: |
          files=$(find ${{ github.event.inputs.basename }} -type f -name "*.feature")
          matrix="::set-output name=matrix::{\"include\":["
          for file in $files; do
            matrix="${matrix}{\"feature\":\"${file}\"},"
          done
          matrix="${matrix%?}]}" # remove trailing comma and close array
          echo $matrix
      
      - name: Print matrix
        run: echo ${{ steps.set-matrix-features.outputs.matrix }}

  run-action:
    needs: get_matrix_features
    runs-on: ubuntu-latest
    strategy:
        matrix: ${{fromJson(needs.get_matrix_features.outputs.matrix)}}
    steps:
        - name: Checkout repo
          uses: actions/checkout@v4
        
        - name: Get locales and environments
          id: get_locales_env
          uses: './.github/actions/get-locales-environment'
          with:
            project: ${{ github.event.inputs.project }}
          # run: |
          #   echo "locales=was:was_de-de" >> $GITHUB_OUTPUT
          #   echo "environments=was:was-live" >> $GITHUB_OUTPUT

        - name: Run action for each file
          id: get-jira-version
          uses: './.github/actions/update-scenarios'
          with:
            project: ${{ github.event.inputs.project }}
            feature: ${{ matrix.feature }}
            locales: ${{ steps.get_locales_env.outputs.locales }}
            environments: ${{ steps.get_locales_env.outputs.environments }}